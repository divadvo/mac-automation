#############################################################################
# macOS System Defaults Configuration (Ansible Implementation)             #
# Alternative to shell script execution - provides better idempotency      #
#############################################################################

###############################################################################
# General UI/UX                                                               #
###############################################################################

- name: Expand save panel by default
  osx_defaults:
    domain: NSGlobalDomain
    key: NSNavPanelExpandedStateForSaveMode
    type: bool
    value: true
  # Original: defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true

- name: Expand print panel by default
  osx_defaults:
    domain: NSGlobalDomain
    key: PMPrintingExpandedStateForPrint
    type: bool
    value: true
  # Original: defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true

- name: Save to disk (not to iCloud) by default
  osx_defaults:
    domain: NSGlobalDomain
    key: NSDocumentSaveNewDocumentsToCloud
    type: bool
    value: false
  # Original: defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false

- name: Automatically quit printer app once print jobs complete
  osx_defaults:
    domain: com.apple.print.PrintingPrefs
    key: "Quit When Finished"
    type: bool
    value: true
  # Original: defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

- name: Check current restart freeze setting
  shell: systemsetup -getrestartfreeze
  register: restart_freeze_current
  become: true
  changed_when: false
  failed_when: false

- name: Restart automatically if computer freezes
  shell: systemsetup -setrestartfreeze on
  become: true
  when: "'On' not in restart_freeze_current.stdout"
  # Original: systemsetup -setrestartfreeze on (requires sudo)

- name: Disable smart quotes (annoying when typing code)
  osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticQuoteSubstitutionEnabled
    type: bool
    value: false
  # Original: defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

- name: Disable smart dashes (annoying when typing code)
  osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticDashSubstitutionEnabled
    type: bool
    value: false
  # Original: defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

# - name: Check current desktop background
#   shell: osascript -e 'tell application "Finder" to get desktop picture as string'
#   register: current_desktop_bg
#   changed_when: false
#   failed_when: false

# - name: Set desktop background to dark-grey stone color
#   shell: osascript -e 'tell application "Finder" to set desktop picture to POSIX file "/System/Library/Desktop Pictures/Solid Colors/Stone.png"'
#   when: "'Stone.png' not in current_desktop_bg.stdout"
#   # Original: osascript -e 'tell application "Finder" to set desktop picture to POSIX file "/System/Library/Desktop Pictures/Solid Colors/Stone.png"'

###############################################################################
# Trackpad, mouse, keyboard, Bluetooth accessories, and input                #
###############################################################################

- name: Set trackpad haptic feedback to light/silent clicking
  osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: FirstClickThreshold
    type: int
    value: 0
  # Original: defaults write com.apple.AppleMultitouchTrackpad FirstClickThreshold -int 0

- name: Set trackpad actuation strength to light
  osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: ActuationStrength
    type: int
    value: 0
  # Original: defaults write com.apple.AppleMultitouchTrackpad ActuationStrength -int 0

- name: Enable trackpad right-click (Bluetooth trackpad)
  osx_defaults:
    domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
    key: TrackpadRightClick
    type: bool
    value: true
  # Original: defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true

- name: Enable trackpad right-click (built-in trackpad)
  osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: TrackpadRightClick
    type: bool
    value: true
  # Original: defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool true

- name: Map trackpad bottom right corner to right-click
  osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: TrackpadCornerSecondaryClick
    type: int
    value: 2
  # Original: defaults write com.apple.AppleMultitouchTrackpad TrackpadCornerSecondaryClick -int 2

- name: Enable context menu gesture
  osx_defaults:
    domain: NSGlobalDomain
    key: ContextMenuGesture
    type: int
    value: 1
  # Original: defaults write NSGlobalDomain ContextMenuGesture -int 1

- name: Disable press-and-hold for keys (favor key repeat)
  osx_defaults:
    domain: NSGlobalDomain
    key: ApplePressAndHoldEnabled
    type: bool
    value: false
  # Original: defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

- name: Set fast keyboard repeat rate
  osx_defaults:
    domain: NSGlobalDomain
    key: InitialKeyRepeat
    type: int
    value: 20
  # Original: defaults write NSGlobalDomain InitialKeyRepeat -int 20

- name: Set blazingly fast keyboard repeat rate
  osx_defaults:
    domain: NSGlobalDomain
    key: KeyRepeat
    type: int
    value: 1
  # Original: defaults write NSGlobalDomain KeyRepeat -int 1

- name: Disable auto-correct
  osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticSpellingCorrectionEnabled
    type: bool
    value: false
  # Original: defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

###############################################################################
# Screen                                                                      #
###############################################################################

- name: Save screenshots to Downloads folder
  osx_defaults:
    domain: com.apple.screencapture
    key: location
    type: string
    value: "{{ ansible_env.HOME }}/Downloads"
  # Original: defaults write com.apple.screencapture location -string "${HOME}/Downloads"

- name: Save screenshots in PNG format
  osx_defaults:
    domain: com.apple.screencapture
    key: type
    type: string
    value: png
  # Original: defaults write com.apple.screencapture type -string "png"

- name: Disable shadow in screenshots
  osx_defaults:
    domain: com.apple.screencapture
    key: disable-shadow
    type: bool
    value: true
  # Original: defaults write com.apple.screencapture disable-shadow -bool true

###############################################################################
# Finder                                                                      #
###############################################################################

- name: Set home directory as default location for new Finder windows
  osx_defaults:
    domain: com.apple.finder
    key: NewWindowTarget
    type: string
    value: PfHm
  # Original: defaults write com.apple.finder NewWindowTarget -string "PfDe"

- name: Set home directory path for new Finder windows
  osx_defaults:
    domain: com.apple.finder
    key: NewWindowTargetPath
    type: string
    value: "file://{{ ansible_env.HOME }}/"
  # Original: defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/"

- name: Show external hard drives on desktop
  osx_defaults:
    domain: com.apple.finder
    key: ShowExternalHardDrivesOnDesktop
    type: bool
    value: true
  # Original: defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool true

- name: Show hard drives on desktop
  osx_defaults:
    domain: com.apple.finder
    key: ShowHardDrivesOnDesktop
    type: bool
    value: true
  # Original: defaults write com.apple.finder ShowHardDrivesOnDesktop -bool true

- name: Show mounted servers on desktop
  osx_defaults:
    domain: com.apple.finder
    key: ShowMountedServersOnDesktop
    type: bool
    value: true
  # Original: defaults write com.apple.finder ShowMountedServersOnDesktop -bool true

- name: Show removable media on desktop
  osx_defaults:
    domain: com.apple.finder
    key: ShowRemovableMediaOnDesktop
    type: bool
    value: true
  # Original: defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true

- name: Show hidden files in Finder by default
  osx_defaults:
    domain: com.apple.finder
    key: AppleShowAllFiles
    type: bool
    value: false
  # Original: defaults write com.apple.finder AppleShowAllFiles -bool true

- name: Show all filename extensions in Finder
  osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true
  # Original: defaults write NSGlobalDomain AppleShowAllExtensions -bool true

- name: Show status bar in Finder
  osx_defaults:
    domain: com.apple.finder
    key: ShowStatusBar
    type: bool
    value: true
  # Original: defaults write com.apple.finder ShowStatusBar -bool true

- name: Allow text selection in Quick Look
  osx_defaults:
    domain: com.apple.finder
    key: QLEnableTextSelection
    type: bool
    value: true
  # Original: defaults write com.apple.finder QLEnableTextSelection -bool true

- name: Display full POSIX path as Finder window title
  osx_defaults:
    domain: com.apple.finder
    key: _FXShowPosixPathInTitle
    type: bool
    value: true
  # Original: defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

- name: Search current folder by default
  osx_defaults:
    domain: com.apple.finder
    key: FXDefaultSearchScope
    type: string
    value: SCcf
  # Original: defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

- name: Disable warning when changing file extension
  osx_defaults:
    domain: com.apple.finder
    key: FXEnableExtensionChangeWarning
    type: bool
    value: false
  # Original: defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

- name: Enable spring loading for directories
  osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.springing.enabled
    type: bool
    value: true
  # Original: defaults write NSGlobalDomain com.apple.springing.enabled -bool true

- name: Remove spring loading delay for directories
  osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.springing.delay
    type: float
    value: 0.1
  # Original: defaults write NSGlobalDomain com.apple.springing.delay -float 0.1

- name: Avoid creating .DS_Store files on network volumes
  osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteNetworkStores
    type: bool
    value: true
  # Original: defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true

- name: Check current desktop icons arrange setting
  shell: /usr/libexec/PlistBuddy -c "Print :DesktopViewSettings:IconViewSettings:arrangeBy" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "none"
  register: desktop_arrange_current
  changed_when: false
  failed_when: false

- name: Enable snap-to-grid for desktop icons
  shell: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist
  when: desktop_arrange_current.stdout != "grid"
  # Original: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist

- name: Check current FK standard view icons arrange setting
  shell: /usr/libexec/PlistBuddy -c "Print :FK_StandardViewSettings:IconViewSettings:arrangeBy" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "none"
  register: fk_arrange_current
  changed_when: false
  failed_when: false

- name: Enable snap-to-grid for FK standard view icons
  shell: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist
  when: fk_arrange_current.stdout != "grid"
  # Original: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist

- name: Check current standard view icons arrange setting
  shell: /usr/libexec/PlistBuddy -c "Print :StandardViewSettings:IconViewSettings:arrangeBy" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "none"
  register: standard_arrange_current
  changed_when: false
  failed_when: false

- name: Enable snap-to-grid for standard view icons
  shell: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist
  when: standard_arrange_current.stdout != "grid"
  # Original: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist

- name: Check current desktop icon size
  shell: /usr/libexec/PlistBuddy -c "Print :DesktopViewSettings:IconViewSettings:iconSize" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "0"
  register: desktop_iconsize_current
  changed_when: false
  failed_when: false

- name: Set desktop icon size to 64px
  shell: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist
  when: desktop_iconsize_current.stdout != "64"
  # Original: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist

- name: Check current FK standard view icon size
  shell: /usr/libexec/PlistBuddy -c "Print :FK_StandardViewSettings:IconViewSettings:iconSize" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "0"
  register: fk_iconsize_current
  changed_when: false
  failed_when: false

- name: Set FK standard view icon size to 64px
  shell: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist
  when: fk_iconsize_current.stdout != "64"
  # Original: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist

- name: Check current standard view icon size
  shell: /usr/libexec/PlistBuddy -c "Print :StandardViewSettings:IconViewSettings:iconSize" ~/Library/Preferences/com.apple.finder.plist 2>/dev/null || echo "0"
  register: standard_iconsize_current
  changed_when: false
  failed_when: false

- name: Set standard view icon size to 64px
  shell: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist
  when: standard_iconsize_current.stdout != "64"
  # Original: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:iconSize 64" ~/Library/Preferences/com.apple.finder.plist

- name: Use column view in all Finder windows by default
  osx_defaults:
    domain: com.apple.finder
    key: FXPreferredViewStyle
    type: string
    value: clmv
  # Original: defaults write com.apple.finder FXPreferredViewStyle -string "clmv"

- name: Check ~/Library folder visibility
  shell: ls -lOd ~/Library | grep -q hidden
  register: library_hidden_check
  changed_when: false
  failed_when: false

- name: Show ~/Library folder
  shell: chflags nohidden ~/Library
  when: library_hidden_check.rc == 0
  # Original: chflags nohidden ~/Library

###############################################################################
# Dock, Dashboard, and hot corners                                           #
###############################################################################

- name: Remove all apps from dock
  osx_defaults:
    domain: com.apple.dock
    key: persistent-apps
    type: array
    value: []
  # Original: defaults write com.apple.dock persistent-apps -array

# Add Chrome to Dock
- name: Check if dockutil command is available
  shell: command -v dockutil
  register: dockutil_check
  failed_when: false
  changed_when: false

- name: Check dockutil version for Sequoia compatibility
  shell: dockutil --version | head -1
  register: dockutil_version_check
  when: dockutil_check.rc == 0
  failed_when: false
  changed_when: false

- name: Display dockutil version for troubleshooting
  debug:
    msg: "Using dockutil version: {{ dockutil_version_check.stdout | default('Not available') }}"
  when: dockutil_check.rc == 0 and dockutil_version_check.stdout is defined

- name: Check if Chrome is already in dock
  shell: dockutil --list | grep -q "Google Chrome"
  register: chrome_in_dock
  when: dockutil_check.rc == 0
  changed_when: false
  failed_when: false

- name: Add Google Chrome to dock using dockutil
  shell: dockutil --add "/Applications/Google Chrome.app"
  when: dockutil_check.rc == 0 and chrome_in_dock.rc != 0
  failed_when: false
  # Original: dockutil --add "/Applications/Google Chrome.app"

- name: Add Google Chrome to dock using defaults (fallback)
  osx_defaults:
    domain: com.apple.dock
    key: persistent-apps
    type: array-add
    value:
      - tile-data:
          file-data:
            _CFURLString: "/Applications/Google Chrome.app"
            _CFURLStringType: 0
  when: dockutil_check.rc != 0
  # Original: defaults write com.apple.dock persistent-apps -array-add '<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>/Applications/Google Chrome.app</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>'

- name: Set dock icon size
  osx_defaults:
    domain: com.apple.dock
    key: tilesize
    type: float
    value: 30
  # Original: defaults write com.apple.dock tilesize -int 30

- name: Position dock on left side
  osx_defaults:
    domain: com.apple.dock
    key: orientation
    type: string
    value: left
  # Original: defaults write com.apple.dock orientation -string "left"

- name: Disable showing recent applications in dock
  osx_defaults:
    domain: com.apple.dock
    key: show-recents
    type: bool
    value: false
  # Original: defaults write com.apple.dock show-recents -bool false

# Remove Downloads folder from dock (Sequoia-compatible)
- name: Initialize dock plist for dockutil
  shell: dockutil --list >/dev/null 2>&1
  when: dockutil_check.rc == 0
  failed_when: false
  changed_when: false

- name: Check if Downloads folder is in dock (dockutil method)
  shell: dockutil --list | grep -i "downloads" | grep -q "folder"
  register: downloads_in_dock_dockutil
  when: dockutil_check.rc == 0
  failed_when: false
  changed_when: false

- name: Check if Downloads folder is in dock (defaults method)
  shell: defaults read com.apple.dock persistent-others 2>/dev/null | grep -q "Downloads" && echo "present" || echo "absent"
  register: downloads_in_dock_defaults
  failed_when: false
  changed_when: false

- name: Debug Downloads folder detection results
  debug:
    msg: 
      - "dockutil detection result: {{ 'Found' if (dockutil_check.rc == 0 and downloads_in_dock_dockutil.rc == 0) else 'Not found' }}"
      - "defaults detection result: {{ downloads_in_dock_defaults.stdout | default('Unknown') }}"
  when: dockutil_check.rc == 0 or downloads_in_dock_defaults.stdout is defined

- name: Remove Downloads folder from dock using dockutil
  shell: dockutil --remove "Downloads" --no-restart
  when: dockutil_check.rc == 0 and downloads_in_dock_dockutil.rc == 0
  failed_when: false

- name: Remove Downloads folder from dock using defaults (fallback method)
  shell: |
    # Get current persistent-others array and remove Downloads entries
    defaults delete com.apple.dock persistent-others 2>/dev/null || true
    # Force dock restart to apply changes
    killall Dock 2>/dev/null || true
  when: >
    (dockutil_check.rc != 0 or downloads_in_dock_dockutil.rc != 0) and 
    downloads_in_dock_defaults.stdout == "present"
  # Fallback: Use defaults delete to completely remove persistent-others array

- name: Speed up Mission Control animations
  osx_defaults:
    domain: com.apple.dock
    key: expose-animation-duration
    type: float
    value: 0.15
  # Original: defaults write com.apple.dock expose-animation-duration -float 0.15

- name: Make dock icons of hidden applications translucent
  osx_defaults:
    domain: com.apple.dock
    key: showhidden
    type: bool
    value: true
  # Original: defaults write com.apple.dock showhidden -bool true

- name: Enable reduce transparency option
  osx_defaults:
    domain: com.apple.universalaccess
    key: reduceTransparency
    type: bool
    value: true
  become: true
  # Original: defaults write com.apple.universalaccess reduceTransparency -bool true

# Hot corners
# Possible values:
#  0: no-op
#  2: Mission Control
#  3: Show application windows
#  4: Desktop
#  5: Start screen saver
#  6: Disable screen saver
#  7: Dashboard
# 10: Put display to sleep
# 11: Launchpad
# 12: Notification Center
# Bottom right screen corner → Mission Control
- name: Set bottom right hot corner to Mission Control
  osx_defaults:
    domain: com.apple.dock
    key: wvous-br-corner
    type: int
    value: 2
  # Original: defaults write com.apple.dock wvous-br-corner -int 2

- name: Set bottom right hot corner modifier
  osx_defaults:
    domain: com.apple.dock
    key: wvous-br-modifier
    type: int
    value: 0
  # Original: defaults write com.apple.dock wvous-br-modifier -int 0

# Top right screen corner → Put display to sleep
- name: Set top right hot corner to put display to sleep
  osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-corner
    type: int
    value: 10
  # Original: defaults write com.apple.dock wvous-tr-corner -int 10

- name: Set top right hot corner modifier
  osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-modifier
    type: int
    value: 0
  # Original: defaults write com.apple.dock wvous-tr-modifier -int 0

# Bottom left screen corner → Desktop
- name: Set bottom left hot corner to Desktop
  osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-corner
    type: int
    value: 4
  # Original: defaults write com.apple.dock wvous-bl-corner -int 4

- name: Set bottom left hot corner modifier
  osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-modifier
    type: int
    value: 0
  # Original: defaults write com.apple.dock wvous-bl-modifier -int 0

###############################################################################
# Safari & WebKit                                                            #
###############################################################################

# Note: Safari tasks may fail due to macOS sandbox/TCC restrictions.
# To enable these settings manually: Safari > Settings > Advanced > Show Develop menu
- name: Enable Safari Develop menu
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari IncludeDevelopMenu -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari IncludeDevelopMenu -bool true

- name: Enable Safari Web Inspector
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true

- name: Enable Safari WebKit2 developer extras
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true

- name: Add Web Inspector context menu item globally
  osx_defaults:
    domain: NSGlobalDomain
    key: WebKitDeveloperExtras
    type: bool
    value: true
  # Original: defaults write NSGlobalDomain WebKitDeveloperExtras -bool true

###############################################################################
# Mail                                                                        #
###############################################################################

- name: Copy email addresses as plain text in Mail.app
  osx_defaults:
    domain: com.apple.mail
    key: AddressesIncludeNameOnPasteboard
    type: bool
    value: false
  # Original: defaults write com.apple.mail AddressesIncludeNameOnPasteboard -bool false

###############################################################################
# Spotlight                                                                  #
###############################################################################

- name: Check current Spotlight exclusions
  shell: defaults read /.Spotlight-V100/VolumeConfiguration Exclusions 2>/dev/null | grep -q "/Volumes" && echo "present" || echo "absent"
  register: spotlight_exclusions_check
  become: true
  changed_when: false
  failed_when: false

- name: Disable Spotlight indexing for mounted volumes
  shell: defaults write /.Spotlight-V100/VolumeConfiguration Exclusions -array "/Volumes"
  become: true
  when: spotlight_exclusions_check.stdout == "absent"
  failed_when: false
  # Original: sudo defaults write /.Spotlight-V100/VolumeConfiguration Exclusions -array "/Volumes"


###############################################################################
# Activity Monitor                                                           #
###############################################################################

- name: Show main window when launching Activity Monitor
  osx_defaults:
    domain: com.apple.ActivityMonitor
    key: OpenMainWindow
    type: bool
    value: true
  # Original: defaults write com.apple.ActivityMonitor OpenMainWindow -bool true

- name: Show all processes in Activity Monitor
  osx_defaults:
    domain: com.apple.ActivityMonitor
    key: ShowCategory
    type: int
    value: 0
  # Original: defaults write com.apple.ActivityMonitor ShowCategory -int 0

###############################################################################
# Messages                                                                   #
###############################################################################

- name: Check Messages automatic quote substitution setting
  shell: defaults read com.apple.messageshelper.MessageController SOInputLineSettings automaticQuoteSubstitutionEnabled 2>/dev/null || echo "1"
  register: messages_quote_setting
  changed_when: false
  failed_when: false

- name: Check Messages continuous spell checking setting
  shell: defaults read com.apple.messageshelper.MessageController SOInputLineSettings continuousSpellCheckingEnabled 2>/dev/null || echo "1"
  register: messages_spell_setting
  changed_when: false
  failed_when: false

- name: Configure Messages spell checking and smart quotes (annoying for code)
  shell: |
    defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "automaticQuoteSubstitutionEnabled" -bool false
    defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "continuousSpellCheckingEnabled" -bool false
  when: messages_quote_setting.stdout != "0" or messages_spell_setting.stdout != "0"

###############################################################################
# App Store                                                                  #
###############################################################################

- name: Disable in-app rating requests from App Store apps
  osx_defaults:
    domain: com.apple.appstore
    key: InAppReviewEnabled
    type: int
    value: 0
  # Original: defaults write com.apple.appstore InAppReviewEnabled -int 0

###############################################################################
# Custom configurations                                                      #
###############################################################################

- name: Disable mouse acceleration
  osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.mouse.scaling
    type: int
    value: -1
  # Original: defaults write NSGlobalDomain com.apple.mouse.scaling -1

- name: Configure menu bar item spacing
  osx_defaults:
    domain: NSGlobalDomain
    host: current
    key: NSStatusItemSpacing
    type: int
    value: 12
  # Original: defaults -currentHost write -globalDomain NSStatusItemSpacing -int 12

- name: Configure menu bar selection padding
  osx_defaults:
    domain: NSGlobalDomain
    host: current
    key: NSStatusItemSelectionPadding
    type: int
    value: 8
  # Original: defaults -currentHost write -globalDomain NSStatusItemSelectionPadding -int 8

- name: Disable click-to-show Desktop
  osx_defaults:
    domain: com.apple.WindowManager
    key: EnableStandardClickToShowDesktop
    type: bool
    value: false
  # Original: defaults write com.apple.WindowManager EnableStandardClickToShowDesktop -bool false

# Note: Safari tasks may fail due to macOS sandbox/TCC restrictions
- name: Show full website address in Safari
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari ShowFullURLInSmartSearchField -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari ShowFullURLInSmartSearchField -bool true

- name: Show Status Bar in Safari
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari ShowStatusBar -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari ShowStatusBar -bool true

- name: Show features for web developers in Safari
  ansible.builtin.shell: |
    defaults write ~/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari IncludeInternalDebugMenu -bool true
  changed_when: true
  ignore_errors: true
  # Original: defaults write com.apple.Safari IncludeInternalDebugMenu -bool true

###############################################################################
# Kill/restart affected applications                                         #
###############################################################################

- name: Restart affected applications
  shell: killall "{{ item }}" > /dev/null 2>&1
  failed_when: false
  loop:
    - cfprefsd
    - ControlCenter
    - Finder
    - Mail
    - SystemUIServer
    - mds
    # Terminal excluded to prevent killing Ansible session
    # Dock excluded as it's handled specifically in dock tasks
  # Original: killall "${app}" > /dev/null 2>&1 for each app

