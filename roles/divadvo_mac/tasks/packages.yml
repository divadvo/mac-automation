- name: Update homebrew package index and install git
  homebrew:
    name: git
    state: latest
    update_homebrew: true
  retries: 3
  delay: 10
  tags:
  - brew

- name: Get installed homebrew formulae
  command: brew list --formula -1
  register: brew_installed_formulae
  changed_when: false
  tags:
  - brew

- name: Install command line tools via homebrew (with progress)
  homebrew:
    name: "{{ item }}"
    state: latest
  loop: "{{ homebrew_packages }}"
  when: item not in brew_installed_formulae.stdout_lines
  retries: 3
  delay: 10
  tags:
  - brew

- name: Get installed homebrew casks
  command: brew list --cask -1
  register: brew_installed_casks
  changed_when: false
  tags:
  - brew

- name: Install GUI applications via homebrew cask (with progress)
  homebrew_cask:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew_cask_packages_test if testing_mode else homebrew_cask_packages }}"
  when: item not in brew_installed_casks.stdout_lines
  retries: 3
  delay: 10
  tags:
  - brew

- name: Configure mise to disable Python tool management
  command: mise settings set disable_tools python
  register: mise_python_setting
  changed_when: "'Setting has been updated' in mise_python_setting.stdout or 'Setting changed' in mise_python_setting.stdout"
  failed_when: false
  tags:
  - mise

- name: Check currently installed mise tools
  command: mise list --current
  register: mise_current_tools
  failed_when: false
  changed_when: false
  tags:
  - mise

- name: Check for newer runtime versions available via mise
  shell: |
    outdated=""
    for pair in "node:{{ node_version }}" "ruby:{{ ruby_version }}" "bun:{{ bun_version }}" "rust:{{ rust_version }}"; do
      tool="${pair%%:*}"
      configured="${pair#*:}"
      latest=$(mise latest "$tool" 2>/dev/null || echo "unknown")
      if [[ "$latest" != "unknown" && "$latest" != "$configured"* ]]; then
        outdated="$outdated\n  - $tool: $configured -> $latest"
      fi
    done
    if [[ -n "$outdated" ]]; then
      echo "Newer versions available:$outdated"
      echo "Update versions in roles/divadvo_mac/vars/main.yml"
    fi
  register: version_check
  changed_when: "'Newer versions available' in version_check.stdout"
  failed_when: false
  tags:
    - mise

- name: Install and activate Node.js via mise (with verbose output)
  command: mise use -g --verbose node@{{ node_version }}
  environment:
    MISE_VERBOSE: "1"
  register: mise_node_install
  changed_when: "'installed' in mise_node_install.stdout or 'activated' in mise_node_install.stdout"
  when: "'node@' + node_version not in mise_current_tools.stdout"
  tags:
  - mise

- name: Install and activate Ruby via mise (with verbose output)
  command: mise use -g --verbose ruby@{{ ruby_version }}
  environment:
    MISE_VERBOSE: "1"
  register: mise_ruby_install
  changed_when: "'installed' in mise_ruby_install.stdout or 'activated' in mise_ruby_install.stdout"
  when: "'ruby@' + ruby_version not in mise_current_tools.stdout"
  tags:
  - mise

- name: Install and activate Bun via mise (with verbose output)
  command: mise use -g --verbose bun@{{ bun_version }}
  environment:
    MISE_VERBOSE: "1"
  register: mise_bun_install
  changed_when: "'installed' in mise_bun_install.stdout or 'activated' in mise_bun_install.stdout"
  when: "'bun@' + bun_version not in mise_current_tools.stdout"
  tags:
  - mise

- name: Install and activate Rust via mise (with verbose output)
  command: mise use -g --verbose rust@{{ rust_version }}
  environment:
    MISE_VERBOSE: "1"
  register: mise_rust_install
  changed_when: "'installed' in mise_rust_install.stdout or 'activated' in mise_rust_install.stdout"
  when: "'rust@' + rust_version not in mise_current_tools.stdout"
  tags:
  - mise

- name: Rebuild mise shims for installed tools
  command: mise reshim
  register: mise_reshim
  changed_when: "'shim' in mise_reshim.stdout"
  tags:
  - mise

- name: Enable corepack for yarn and pnpm
  command: mise x -- corepack enable
  register: corepack_enable
  changed_when: false
  tags:
  - node

- name: Check installed Python versions
  command: uv python list
  register: uv_python_list
  failed_when: false
  changed_when: false
  tags:
  - uv

- name: Install Python versions via uv (only missing ones)
  command: >
    uv python install {{ item }}
  loop: "{{ python_versions }}"
  when: "item not in uv_python_list.stdout"
  register: uv_python_install
  tags:
  - uv

- name: Install Python tools via uv
  command: >
    uv tool install
    --python 3.13
    {{ item.name }}
    {% if item.with is defined %}
    {% for w in item.with %}--with {{ w }}{% endfor %}
    {% endif %}
  loop: '{{ uv_tools }}'
  register: uv_tool_install
  changed_when: "'already installed' not in uv_tool_install.stderr"
  tags:
  - uv

- name: Upgrade Python tools via uv
  command: >
    uv tool upgrade
    {{ item.name }}
    {% if item.with is defined %}
    {% for w in item.with %}--upgrade-package {{ w }}{% endfor %}
    {% endif %}
  loop: '{{ uv_tools }}'
  register: uv_upgrade
  changed_when: "'Nothing to upgrade' not in uv_upgrade.stderr"
  tags:
  - uv

- name: Install oh-my-zsh shell framework
  shell: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  args:
    creates: ~/.oh-my-zsh
  retries: 3
  delay: 10
  become: false

- name: Install Powerlevel10k zsh theme
  git:
    repo: https://github.com/romkatv/powerlevel10k.git
    dest: ~/.oh-my-zsh/custom/themes/powerlevel10k
    depth: 1
  retries: 3
  delay: 10
  become: false

- name: Install Oh My Zsh custom plugins
  git:
    repo: "{{ item.repo }}"
    dest: "~/.oh-my-zsh/custom/plugins/{{ item.name }}"
    depth: 1
  loop: "{{ ohmyzsh_custom_plugins }}"
  retries: 3
  delay: 10
  become: false

- name: Install NVChad Neovim configuration
  git:
    repo: https://github.com/NvChad/starter
    dest: ~/.config/nvim
    depth: 1
  retries: 3
  delay: 10
  become: false

- name: Check PostgreSQL service status
  shell: brew services list | grep postgresql@{{ postgresql_version }}
  register: postgres_status
  changed_when: false
  failed_when: false
  become: false

- name: Start and enable PostgreSQL database service
  shell: brew services start postgresql@{{ postgresql_version }}
  register: postgres_start
  changed_when: "'Successfully started' in postgres_start.stdout"
  when: "'started' not in postgres_status.stdout"
  become: false