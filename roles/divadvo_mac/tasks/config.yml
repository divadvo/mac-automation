- name: Create required dotfiles directories
  file:
    path: '~/.{{ item }}'
    state: directory
  loop:
  - innotop
  - ipython/profile_default/startup
  - config/atuin
  - config/gh
  - config/git
  - config/pip
  - config/zed
  tags:
  - dotfiles

- name: Create symlinks for dotfiles configuration
  file:
    src: '{{ ansible_env.PWD }}/roles/divadvo_mac/files/dotfiles/{{ item }}'
    path: '~/.{{ item }}'
    state: link
    force: yes # Remove file first, in case it exists
  loop:
  - config/ripgreprc
  - config/git/attributes
  - config/git/config
  - config/git/ignore
  - ssh/config
  - zprofile
  - p10k.zsh
  tags:
  - dotfiles

- name: Template zshrc configuration file
  template:
    src: zshrc.j2
    dest: ~/.zshrc
    backup: yes
  tags:
  - dotfiles

# Configure iTerm2 to use custom preferences from David.json
# This loads color schemes, profiles, and other iTerm2 settings
- name: Configure iTerm2 to use custom preferences folder
  osx_defaults:
    domain: com.googlecode.iterm2
    key: PrefsCustomFolder
    type: string
    value: "{{ ansible_env.PWD }}/roles/divadvo_mac/files/dotfiles/iterm2"
  tags:
  - iterm

- name: Enable iTerm2 custom preferences loading
  osx_defaults:
    domain: com.googlecode.iterm2
    key: LoadPrefsFromCustomFolder
    type: boolean
    value: true
  tags:
  - iterm

## Run configs for mac stuff https://github.com/geerlingguy/dotfiles/blob/master/.osx
## --no-restart

- name: Apply macOS system defaults via Ansible tasks
  import_tasks: macos_defaults.yml
  when: use_ansible_macos_config | default(false)
  tags:
  - macos
  - ansible_config
  - never

- name: Apply macOS system defaults via shell script
  command: "{{ role_path }}/files/dotfiles/osx"
  changed_when: false
  become: false
  when: not (use_ansible_macos_config | default(false))
  tags:
  - macos
  - shell_config
  - never